<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMI Amortization Calculator</title>
    <!-- Custom Favicon mimicking the provided image -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üòâ</text><text x=%225%22 y=%2235%22 font-size=%2245%22 transform=%22rotate(-20 25 35)%22>üëë</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .table-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 4px;
            text-align: right;
            transition: all 0.2s;
        }
        .table-input:hover {
            border-color: #cbd5e1;
        }
        .dark .table-input:hover {
            border-color: #475569;
        }
        .table-input:focus {
            background: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .dark .table-input:focus {
            background: #1e293b;
        }

        .paid-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        #pBar, #iBar {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 p-4 md:p-8 transition-colors duration-300">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 id="title" class="text-3xl font-bold flex items-center gap-2 text-slate-900 dark:text-white">
                    <span class="text-blue-600">üìä</span> EMI Amortization Spreadsheet
                </h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Manual tracking with Local Storage</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="syncStatus" class="text-[10px] font-bold uppercase px-2 py-1 rounded bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400">Offline Saved</div>
                <button onclick="toggleTheme()" class="p-2 rounded-lg border bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-600 dark:text-amber-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm" id="themeBtn">
                    ‚òÄÔ∏è Light Mode
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Controls -->
            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 lg:col-span-1 h-fit">
                <h2 class="text-lg font-semibold mb-4 dark:text-white border-b border-slate-100 dark:border-slate-800 pb-2">Loan Setup</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Loan Amount (‚Çπ)</label>
                        <input type="number" id="amount" value="2000000" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Interest Rate (%)</label>
                        <input type="number" id="rate" step="0.01" value="9.25" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Initial Tenure (Months)</label>
                        <input type="number" id="months" value="180" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>

                    <div class="pt-4 mt-4 border-t border-slate-100 dark:border-slate-800 flex justify-between gap-2">
                        <button onclick="clearManualPayments()" class="flex-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-semibold hover:bg-red-50 dark:hover:bg-red-950/30 hover:text-red-600 transition-colors">Reset Extra</button>
                        <button onclick="clearStatus()" class="flex-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-semibold hover:bg-amber-50 dark:hover:bg-amber-950/30 hover:text-amber-600 transition-colors">Reset Status</button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-cyan-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-cyan-100 text-sm font-medium">Total Principal Paid</p>
                    <h3 id="totalPrincipalPaidDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-orange-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-orange-100 text-sm font-medium">Total Interest Paid</p>
                    <h3 id="totalInterestPaidDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-blue-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-blue-100 text-sm font-medium">Monthly EMI</p>
                    <h3 id="emiDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>

                <div class="bg-slate-800 dark:bg-slate-900 p-6 rounded-2xl shadow-md text-white border border-slate-700">
                    <p class="text-slate-400 text-sm font-medium">Remaining Principal</p>
                    <h3 id="remainingPrincipalDisplay" class="text-2xl font-bold mt-1 text-blue-400">‚Çπ0</h3>
                </div>
                <div class="bg-rose-600 p-6 rounded-2xl shadow-md text-white border border-rose-500">
                    <p class="text-rose-100 text-sm font-medium">Remaining Interest</p>
                    <h3 id="totalRemainingInterestDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-indigo-700 p-6 rounded-2xl shadow-md text-white border border-indigo-600">
                    <p class="text-indigo-200 text-sm font-medium">Months Remaining</p>
                    <h3 id="monthsRemainingDisplay" class="text-2xl font-bold mt-1">0</h3>
                </div>

                <div class="bg-emerald-600 p-6 rounded-2xl shadow-md text-white md:col-span-1">
                    <p class="text-emerald-100 text-sm font-medium">Future Interest Savings</p>
                    <h3 id="savingsDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 md:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-tight">Payoff Ratio (Unpaid)</p>
                        <span id="savingsBadge" class="hidden px-2 py-0.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-[10px] font-bold rounded uppercase">Extra Paid</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 h-4 rounded-full overflow-hidden flex" id="progressBar">
                        <div id="pBar" class="bg-blue-500 h-full w-0"></div>
                        <div id="iBar" class="bg-rose-500 h-full w-0"></div>
                    </div>
                    <div class="flex justify-between mt-3 text-[10px] font-medium dark:text-slate-400">
                        <span id="pLabel">Remaining Principal</span>
                        <span id="iLabel">Remaining Interest</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between bg-slate-50/50 dark:bg-slate-800/50">
                <h2 class="font-semibold dark:text-white flex items-center gap-2">
                    Corrected Amortization Schedule
                    <span class="text-[10px] bg-emerald-100 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Mark Paid vs Projected</span>
                </h2>
            </div>
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-10 shadow-sm">
                        <tr class="text-xs uppercase tracking-wider font-semibold text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800">
                            <th class="px-6 py-4">Month</th>
                            <th class="px-6 py-4 text-center">Paid?</th>
                            <th class="px-6 py-4">Opening Bal.</th>
                            <th class="px-6 py-4">Interest</th>
                            <th class="px-6 py-4">Principal (EMI)</th>
                            <th class="px-6 py-4 bg-emerald-50/50 dark:bg-emerald-900/10 text-emerald-600 dark:text-emerald-400">Extra Principal</th>
                            <th class="px-6 py-4 text-right">Closing Bal.</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // State
        let manualPrepayments = {};
        let paidStatus = {};
        const STORAGE_KEY = 'emi_tracker_data';

        // Initialize Theme and Data
        window.onload = () => {
            loadFromLocalStorage();
            calculate();
        };

        function saveToLocalStorage() {
            const data = {
                manualPrepayments,
                paidStatus,
                amount: document.getElementById('amount').value,
                rate: document.getElementById('rate').value,
                months: document.getElementById('months').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                manualPrepayments = data.manualPrepayments || {};
                paidStatus = data.paidStatus || {};
                if (data.amount) document.getElementById('amount').value = data.amount;
                if (data.rate) document.getElementById('rate').value = data.rate;
                if (data.months) document.getElementById('months').value = data.months;
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const btn = document.getElementById('themeBtn');
            btn.innerHTML = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
        }

        window.updateManualPayment = (month, value) => {
            const val = parseFloat(value) || 0;
            if (value === "" || val === 0) {
                delete manualPrepayments[month.toString()];
            } else {
                manualPrepayments[month.toString()] = val;
            }
            calculate();
            saveToLocalStorage();
        };

        window.togglePaidStatus = (month) => {
            paidStatus[month.toString()] = !paidStatus[month.toString()];
            calculate();
            saveToLocalStorage();
        };

        window.handleInputUpdate = () => {
            calculate();
            saveToLocalStorage();
        };

        window.clearManualPayments = () => {
            manualPrepayments = {};
            calculate();
            saveToLocalStorage();
        };

        window.clearStatus = () => {
            paidStatus = {};
            calculate();
            saveToLocalStorage();
        };

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(num);
        }

        function calculate() {
            const P_initial = parseFloat(document.getElementById('amount').value) || 0;
            const annualRate = parseFloat(document.getElementById('rate').value) || 0;
            const nTotal = parseFloat(document.getElementById('months').value) || 0;
            const r = annualRate / 12 / 100;

            let emi = 0;
            if (r > 0 && nTotal > 0) {
                emi = (P_initial * r * Math.pow(1 + r, nTotal)) / (Math.pow(1 + r, nTotal) - 1);
            } else if (nTotal > 0) {
                emi = P_initial / nTotal;
            }
            document.getElementById('emiDisplay').innerText = formatCurrency(emi);

            let totalStandardInterest = 0;
            let tempFullBal = P_initial;
            for(let k=1; k<=nTotal; k++) {
                let interest = tempFullBal * r;
                let principal = emi - interest;
                totalStandardInterest += interest;
                tempFullBal -= principal;
            }

            const scheduleBody = document.getElementById('scheduleBody');
            let currentBalance = P_initial;
            let totalInterestRemaining = 0;
            let unpaidMonthsCount = 0;
            let actualRemainingPrincipal = P_initial;
            let totalExtraPaid = 0;
            let cumulativeInterestPaid = 0;

            let lastPaidMonth = 0;
            Object.keys(paidStatus).forEach(m => {
                if (paidStatus[m]) lastPaidMonth = Math.max(lastPaidMonth, parseInt(m));
            });

            let activeInputId = document.activeElement ? document.activeElement.id : null;
            let rowIdx = 0;

            for (let i = 1; i <= 600; i++) {
                if (currentBalance <= 0 && i > lastPaidMonth) break;

                let interest = currentBalance * r;
                let principalFromEMI = emi - interest;
                let extraPaid = manualPrepayments[i.toString()] || 0;
                totalExtraPaid += extraPaid;
                
                let isPaid = paidStatus[i.toString()] || false;
                let totalPrincipalThisMonth = principalFromEMI + extraPaid;

                if (currentBalance < totalPrincipalThisMonth) {
                    totalPrincipalThisMonth = currentBalance;
                }

                let closing = Math.max(0, currentBalance - totalPrincipalThisMonth);
                
                if (isPaid) {
                    actualRemainingPrincipal = closing;
                    cumulativeInterestPaid += interest;
                } else {
                    totalInterestRemaining += interest;
                    unpaidMonthsCount++;
                }

                let row = scheduleBody.rows[rowIdx];
                if (!row) {
                    row = scheduleBody.insertRow();
                    row.className = 'text-sm transition-colors';
                    for (let c = 0; c < 7; c++) row.insertCell();
                }

                row.className = `text-sm ${isPaid ? 'bg-blue-50/30 dark:bg-blue-900/10' : 'hover:bg-slate-50 dark:hover:bg-slate-800/50'}`;
                row.cells[0].className = 'px-6 py-3 font-medium text-xs text-slate-400';
                row.cells[0].textContent = i;

                if (!row.cells[1].innerHTML) {
                    row.cells[1].className = 'px-6 py-3 text-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'paid-checkbox';
                    checkbox.onclick = () => togglePaidStatus(i);
                    row.cells[1].appendChild(checkbox);
                }
                row.cells[1].querySelector('input').checked = isPaid;

                row.cells[2].className = 'px-6 py-3 dark:text-slate-300';
                row.cells[2].textContent = `‚Çπ${currentBalance.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                row.cells[3].className = 'px-6 py-3 text-red-500';
                row.cells[3].textContent = `‚Çπ${interest.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                row.cells[4].className = 'px-6 py-3 text-slate-600 dark:text-slate-400';
                row.cells[4].textContent = `‚Çπ${principalFromEMI.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                if (!row.cells[5].innerHTML) {
                    row.cells[5].className = 'px-6 py-3 bg-emerald-50/30 dark:bg-emerald-900/5';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `manualInput_${i}`;
                    input.placeholder = '0';
                    input.className = 'table-input font-bold text-emerald-600 dark:text-emerald-400';
                    input.oninput = (e) => updateManualPayment(i, e.target.value);
                    row.cells[5].appendChild(input);
                }
                const cellInput = row.cells[5].querySelector('input');
                if (cellInput.id !== activeInputId) {
                    cellInput.value = manualPrepayments[i.toString()] || '';
                }

                row.cells[6].className = 'px-6 py-3 text-right font-semibold dark:text-slate-200';
                row.cells[6].textContent = `‚Çπ${closing.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                currentBalance = closing;
                rowIdx++;
                if (i > 600) break; 
            }

            while (scheduleBody.rows.length > rowIdx) {
                scheduleBody.deleteRow(rowIdx);
            }

            const totalPrincipalPaidSoFar = Math.max(0, P_initial - actualRemainingPrincipal);
            document.getElementById('remainingPrincipalDisplay').innerText = formatCurrency(actualRemainingPrincipal);
            document.getElementById('totalInterestPaidDisplay').innerText = formatCurrency(cumulativeInterestPaid);
            document.getElementById('totalRemainingInterestDisplay').innerText = formatCurrency(totalInterestRemaining);
            document.getElementById('totalPrincipalPaidDisplay').innerText = formatCurrency(totalPrincipalPaidSoFar);
            document.getElementById('monthsRemainingDisplay').innerText = unpaidMonthsCount;
            
            let plannedInterestRemaining = Math.max(0, totalStandardInterest - cumulativeInterestPaid);
            let interestSaved = Math.max(0, plannedInterestRemaining - totalInterestRemaining);
            document.getElementById('savingsDisplay').innerText = formatCurrency(interestSaved);
            
            if (totalExtraPaid > 0) {
                document.getElementById('savingsBadge').classList.remove('hidden');
            } else {
                document.getElementById('savingsBadge').classList.add('hidden');
            }

            const totalRemainingValue = actualRemainingPrincipal + totalInterestRemaining;
            const pPercent = totalRemainingValue > 0 ? (actualRemainingPrincipal / totalRemainingValue) * 100 : 0;
            const iPercent = totalRemainingValue > 0 ? (totalInterestRemaining / totalRemainingValue) * 100 : 0;
            
            document.getElementById('pBar').style.width = pPercent + '%';
            document.getElementById('iBar').style.width = iPercent + '%';
            document.getElementById('pLabel').innerText = `Principal: ${pPercent.toFixed(1)}%`;
            document.getElementById('iLabel').innerText = `Interest: ${iPercent.toFixed(1)}%`;
        }
    </script>
</body>
</html>
