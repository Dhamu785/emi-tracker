<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMI Amortization Calculator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üòâ</text><text x=%225%22 y=%2235%22 font-size=%2245%22 transform=%22rotate(-20 25 35)%22>üëë</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .table-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 2px 4px;
            text-align: right;
            transition: all 0.2s;
        }
        .table-input:hover {
            border-color: #cbd5e1;
        }
        .dark .table-input:hover {
            border-color: #475569;
        }
        .table-input:focus {
            background: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .dark .table-input:focus {
            background: #1e293b;
        }

        .paid-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        #pBar, #iBar {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 p-4 md:p-8 transition-colors duration-300">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 id="title" class="text-3xl font-bold flex items-center gap-2 text-slate-900 dark:text-white">
                    <span class="text-blue-600">üìä</span> EMI Amortization Spreadsheet
                </h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Manual tracking with Local Storage</p>
            </div>
            <div class="flex flex-col sm:flex-row items-end sm:items-center gap-3">
                <!-- Interest Type Toggle Button Group -->
                <div class="inline-flex rounded-xl p-1 bg-slate-200 dark:bg-slate-900 border border-slate-300 dark:border-slate-800 shadow-inner">
                    <button id="reducingBtn" onclick="setInterestType('reducing')" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 shadow-sm bg-blue-600 text-white">Reducing</button>
                    <button id="flatBtn" onclick="setInterestType('flat')" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">Flat Rate</button>
                </div>
                
                <div class="flex items-center gap-2">
                    <div id="syncStatus" class="text-[10px] font-bold uppercase px-2 py-1 rounded bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400">Offline Saved</div>
                    <button onclick="toggleTheme()" class="p-2 rounded-lg border bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-600 dark:text-amber-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-sm" id="themeBtn">
                        ‚òÄÔ∏è Light Mode
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Controls -->
            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 lg:col-span-1 h-fit">
                <h2 class="text-lg font-semibold mb-4 dark:text-white border-b border-slate-100 dark:border-slate-800 pb-2">Loan Setup</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Loan Amount (‚Çπ)</label>
                        <input type="number" id="amount" value="10000" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Interest Rate (%)</label>
                        <input type="number" id="rate" step="0.01" value="6" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Initial Tenure (Months)</label>
                        <input type="number" id="months" value="12" oninput="handleInputUpdate()" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>

                    <div class="pt-4 mt-4 border-t border-slate-100 dark:border-slate-800 flex justify-between gap-2">
                        <button onclick="clearManualPayments()" class="flex-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-semibold hover:bg-red-50 dark:hover:bg-red-950/30 hover:text-red-600 transition-colors">Reset Extra</button>
                        <button onclick="clearStatus()" class="flex-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-semibold hover:bg-amber-50 dark:hover:bg-amber-950/30 hover:text-amber-600 transition-colors">Reset Status</button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Row 1: The Paid Metrics -->
                <div class="bg-cyan-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-cyan-100 text-sm font-medium">Total Principal Paid</p>
                    <h3 id="totalPrincipalPaidDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-orange-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-orange-100 text-sm font-medium">Total Interest Paid</p>
                    <h3 id="totalInterestPaidDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-blue-600 p-6 rounded-2xl shadow-md text-white">
                    <p class="text-blue-100 text-sm font-medium">Monthly EMI</p>
                    <h3 id="emiDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>

                <!-- Row 2: The Remaining Metrics -->
                <div class="bg-slate-800 dark:bg-slate-900 p-6 rounded-2xl shadow-md text-white border border-slate-700">
                    <p class="text-slate-400 text-sm font-medium">Remaining Principal</p>
                    <h3 id="remainingPrincipalDisplay" class="text-2xl font-bold mt-1 text-blue-400">‚Çπ0</h3>
                </div>
                <div class="bg-rose-600 p-6 rounded-2xl shadow-md text-white border border-rose-500">
                    <p class="text-rose-100 text-sm font-medium">Remaining Interest</p>
                    <h3 id="totalRemainingInterestDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-indigo-700 p-6 rounded-2xl shadow-md text-white border border-indigo-600">
                    <p class="text-indigo-200 text-sm font-medium">Months Remaining</p>
                    <h3 id="monthsRemainingDisplay" class="text-2xl font-bold mt-1">0</h3>
                </div>

                <!-- Row 3: Analysis -->
                <div class="bg-emerald-600 p-6 rounded-2xl shadow-md text-white md:col-span-1">
                    <p class="text-emerald-100 text-sm font-medium">Future Interest Savings</p>
                    <h3 id="savingsDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>
                <div class="bg-violet-600 p-6 rounded-2xl shadow-md text-white md:col-span-1">
                    <p class="text-violet-100 text-sm font-medium">Total Amount Paid</p>
                    <h3 id="totalAmountPaidDisplay" class="text-2xl font-bold mt-1">‚Çπ0</h3>
                </div>

                <!-- Ratio Bar ‚Äî full row -->
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 md:col-span-3">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-tight">Current Payoff Ratio (Unpaid)</p>
                        <span id="savingsBadge" class="hidden px-2 py-0.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-[10px] font-bold rounded uppercase">Extra Paid</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 h-4 rounded-full overflow-hidden flex" id="progressBar">
                        <div id="pBar" class="bg-blue-500 h-full w-0"></div>
                        <div id="iBar" class="bg-rose-500 h-full w-0"></div>
                    </div>
                    <div class="flex justify-between mt-3 text-[10px] font-medium dark:text-slate-400">
                        <span id="pLabel">Remaining Principal</span>
                        <span id="iLabel">Remaining Interest</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex flex-wrap items-center justify-between gap-3 bg-slate-50/50 dark:bg-slate-800/50">
                <h2 class="font-semibold dark:text-white flex items-center gap-2">
                    Corrected Amortization Schedule
                    <span class="text-[10px] bg-emerald-100 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Mark Paid vs Projected</span>
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="exportCSV()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-green-50 dark:hover:bg-green-950/30 hover:text-green-700 dark:hover:text-green-400 border border-slate-200 dark:border-slate-700 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                        CSV
                    </button>
                    <button onclick="exportPDF()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-red-50 dark:hover:bg-red-950/30 hover:text-red-600 dark:hover:text-red-400 border border-slate-200 dark:border-slate-700 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        PDF
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-10 shadow-sm">
                        <tr class="text-xs uppercase tracking-wider font-semibold text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800">
                            <th class="px-6 py-4">Month</th>
                            <th class="px-6 py-4 text-center">Paid?</th>
                            <th class="px-6 py-4">Opening Bal.</th>
                            <th class="px-6 py-4">Interest</th>
                            <th class="px-6 py-4">Principal (EMI)</th>
                            <th class="px-6 py-4 bg-emerald-50/50 dark:bg-emerald-900/10 text-emerald-600 dark:text-emerald-400">Extra Principal</th>
                            <th class="px-6 py-4 text-right">Closing Bal.</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // State
        let manualPrepayments = {};
        let paidStatus = {};
        let currentInterestType = 'reducing';
        const STORAGE_KEY = 'emi_tracker_data';

        // Initialize Theme and Data
        window.onload = () => {
            loadFromLocalStorage();
            calculate();
        };

        function saveToLocalStorage() {
            try {
                const data = {
                    // FIX 4: wrap in try/catch ‚Äî if localStorage is full or unavailable, fail silently
                    manualPrepayments,
                    paidStatus,
                    interestType: currentInterestType,
                    amount: document.getElementById('amount').value,
                    rate: document.getElementById('rate').value,
                    months: document.getElementById('months').value,
                    _schemaVersion: 1  // version tag for future migrations
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.warn('LocalStorage save failed:', e);
            }
        }

        function loadFromLocalStorage() {
            // FIX 4: wrap JSON.parse in try/catch ‚Äî corrupt data no longer crashes the app
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    // Schema version check ‚Äî reset unknown versions to avoid broken state
                    if (data._schemaVersion !== 1) {
                        console.warn('Unknown schema version, resetting to defaults.');
                        localStorage.removeItem(STORAGE_KEY);
                        return;
                    }
                    manualPrepayments = data.manualPrepayments || {};
                    paidStatus = data.paidStatus || {};
                    if (data.interestType) {
                        setInterestType(data.interestType, false);
                    }
                    if (data.amount) document.getElementById('amount').value = data.amount;
                    if (data.rate) document.getElementById('rate').value = data.rate;
                    if (data.months) document.getElementById('months').value = data.months;
                }
            } catch (e) {
                // FIX 4: corrupted JSON ‚Äî clear bad data and start fresh rather than crashing
                console.warn('LocalStorage data corrupted, resetting:', e);
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const btn = document.getElementById('themeBtn');
            btn.innerHTML = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
        }

        function setInterestType(type, shouldSave = true) {
            currentInterestType = type;
            const reducingBtn = document.getElementById('reducingBtn');
            const flatBtn = document.getElementById('flatBtn');

            if (type === 'reducing') {
                reducingBtn.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 shadow-sm bg-blue-600 text-white";
                flatBtn.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200";
            } else {
                flatBtn.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 shadow-sm bg-blue-600 text-white";
                reducingBtn.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200";
            }

            if (shouldSave) {
                calculate();
                saveToLocalStorage();
            }
        }

        window.updateManualPayment = (month, value) => {
            const val = parseFloat(value) || 0;
            if (value === "" || val === 0) {
                delete manualPrepayments[month.toString()];
            } else {
                manualPrepayments[month.toString()] = val;
            }
            calculate();
            saveToLocalStorage();
        };

        window.togglePaidStatus = (month) => {
            paidStatus[month.toString()] = !paidStatus[month.toString()];
            calculate();
            saveToLocalStorage();
        };

        window.handleInputUpdate = () => {
            calculate();
            saveToLocalStorage();
        };

        window.clearManualPayments = () => {
            manualPrepayments = {};
            calculate();
            saveToLocalStorage();
        };

        window.clearStatus = () => {
            paidStatus = {};
            calculate();
            saveToLocalStorage();
        };

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(num);
        }

        function calculate() {
            const P_initial = parseFloat(document.getElementById('amount').value) || 0;
            const annualRate = parseFloat(document.getElementById('rate').value) || 0;
            const nTotal = parseFloat(document.getElementById('months').value) || 0;

            // FIX 3: Guard against months = 0 or negative ‚Äî prevents NaN/Infinity propagation
            if (nTotal <= 0 || P_initial <= 0) {
                document.getElementById('emiDisplay').innerText = formatCurrency(0);
                document.getElementById('remainingPrincipalDisplay').innerText = formatCurrency(0);
                document.getElementById('totalInterestPaidDisplay').innerText = formatCurrency(0);
                document.getElementById('totalRemainingInterestDisplay').innerText = formatCurrency(0);
                document.getElementById('totalPrincipalPaidDisplay').innerText = formatCurrency(0);
                document.getElementById('monthsRemainingDisplay').innerText = '0';
                document.getElementById('totalAmountPaidDisplay').innerText = formatCurrency(0);
                document.getElementById('savingsDisplay').innerText = formatCurrency(0);
                document.getElementById('pBar').style.width = '0%';
                document.getElementById('iBar').style.width = '0%';
                document.getElementById('scheduleBody').innerHTML = '';
                return;
            }

            const r = annualRate / 12 / 100;

            // --- EMI Calculation ---
            let emi = 0;
            // FIX 1: For flat rate, EMI is computed on the original principal/tenure for display only.
            // The interest per row will be recalculated dynamically based on remaining balance,
            // so prepayments correctly reduce future flat-rate interest.
            // We preserve the original flat-rate EMI amount (principal portion grows as balance shrinks).
            let flatMonthlyRate = annualRate / 12 / 100; // same rate applied to outstanding balance each month

            if (currentInterestType === 'flat') {
                // Flat Rate EMI: total interest is based on original P and n, split evenly
                const totalFlatInterest = P_initial * (annualRate / 100) * (nTotal / 12);
                emi = (P_initial + totalFlatInterest) / nTotal;
            } else {
                // Reducing Balance
                if (r > 0 && nTotal > 0) {
                    emi = (P_initial * r * Math.pow(1 + r, nTotal)) / (Math.pow(1 + r, nTotal) - 1);
                } else {
                    emi = P_initial / nTotal;
                }
            }

            document.getElementById('emiDisplay').innerText = formatCurrency(emi);

            // --- Standard Projection (no prepayments, no paid status) for savings baseline ---
            // FIX 5: Compute baseline total interest correctly using the same per-row logic
            // so the savings calculation uses an apples-to-apples comparison.
            let totalStandardInterest = 0;
            {
                let tempBal = P_initial;
                for (let k = 1; k <= 600; k++) {
                    if (tempBal <= 0) break;
                    // FIX 1: For flat rate baseline, also use balance-based interest
                    // so that the savings reference matches the live calculation method
                    let interestVal = tempBal * flatMonthlyRate; // works for both modes (r === flatMonthlyRate for reducing)
                    if (currentInterestType === 'reducing') {
                        interestVal = tempBal * r;
                    }
                    let principalVal = Math.min(emi - interestVal, tempBal);
                    if (principalVal < 0) principalVal = 0;
                    totalStandardInterest += interestVal;
                    tempBal -= principalVal;
                    tempBal = Math.max(0, tempBal);
                }
            }

            // --- Main Amortization Loop ---
            const scheduleBody = document.getElementById('scheduleBody');
            let currentBalance = P_initial;
            let totalInterestRemaining = 0;
            let unpaidMonthsCount = 0;
            let totalExtraPaid = 0;
            let cumulativeInterestPaid = 0;
            let cumulativePrincipalPaid = 0;

            // FIX 2: Determine the cutoff month for "paid" metrics by finding the highest
            // consecutive paid month starting from month 1. This prevents out-of-order
            // paid checkboxes from producing wrong running balances.
            // We still SHOW all rows regardless, but metrics are derived from consecutive paid run.
            let consecutivePaidUpTo = 0;
            for (let m = 1; m <= 600; m++) {
                if (paidStatus[m.toString()]) {
                    consecutivePaidUpTo = m;
                } else {
                    break; // stop at first unpaid gap
                }
            }

            let lastPaidMonth = 0;
            Object.keys(paidStatus).forEach(m => {
                if (paidStatus[m]) lastPaidMonth = Math.max(lastPaidMonth, parseInt(m));
            });

            let activeInputId = document.activeElement ? document.activeElement.id : null;
            let rowIdx = 0;

            // We need a two-pass approach for FIX 2:
            // Pass 1 ‚Äî build the full schedule array (balance flows correctly with prepayments)
            // Pass 2 ‚Äî render rows and derive metrics from it
            const schedule = [];
            {
                let bal = P_initial;
                for (let i = 1; i <= 600; i++) {
                    if (bal <= 0 && i > lastPaidMonth) break;

                    // FIX 1: For BOTH modes, compute interest against the current outstanding balance.
                    // This means flat-rate prepayments correctly reduce future interest charges.
                    let interest = bal * (currentInterestType === 'reducing' ? r : flatMonthlyRate);
                    let principalFromEMI = emi - interest;

                    // Guard: if interest alone exceeds EMI (very high rate / very long term),
                    // ensure principal portion is at least 0 to avoid infinite loop
                    if (principalFromEMI < 0) principalFromEMI = 0;

                    let extraPaid = manualPrepayments[i.toString()] || 0;
                    totalExtraPaid += extraPaid;

                    let totalPrincipalThisMonth = principalFromEMI + extraPaid;
                    if (bal < totalPrincipalThisMonth) {
                        totalPrincipalThisMonth = bal;
                    }

                    let closing = Math.max(0, bal - totalPrincipalThisMonth);

                    schedule.push({
                        month: i,
                        opening: bal,
                        interest,
                        principalFromEMI: Math.min(principalFromEMI, bal),
                        extraPaid,
                        closing,
                        isPaid: !!(paidStatus[i.toString()])
                    });

                    bal = closing;
                }
            }

            // FIX 2: Derive paid/remaining metrics from the schedule using consecutivePaidUpTo.
            // "Paid" metrics only count months 1..consecutivePaidUpTo so out-of-order marks
            // don't silently produce incorrect running balances.
            let actualRemainingPrincipal = P_initial;
            for (let idx = 0; idx < schedule.length; idx++) {
                const row = schedule[idx];
                if (row.month <= consecutivePaidUpTo) {
                    cumulativeInterestPaid += row.interest;
                    cumulativePrincipalPaid += row.principalFromEMI + row.extraPaid;
                    actualRemainingPrincipal = row.closing;
                } else {
                    totalInterestRemaining += row.interest;
                    unpaidMonthsCount++;
                }
            }

            // Clamp remaining principal to valid range
            actualRemainingPrincipal = Math.max(0, actualRemainingPrincipal);
            const totalPrincipalPaidSoFar = Math.max(0, P_initial - actualRemainingPrincipal);

            // FIX 5: Savings = interest that WOULD have been paid without prepayments from
            // consecutivePaidUpTo onward, minus the actual remaining interest on the
            // accelerated schedule. This avoids the Math.max(0,...) masking of negative values.
            const paidMonthsBaselineInterest = (() => {
                // Recompute baseline interest for just the remaining months (from consecutivePaidUpTo+1)
                // on the standard schedule to get apples-to-apples future interest
                let tempBal2 = P_initial;
                let accInterestUpToCutoff = 0;
                for (let k = 1; k <= 600; k++) {
                    if (tempBal2 <= 0) break;
                    let iVal = tempBal2 * (currentInterestType === 'reducing' ? r : flatMonthlyRate);
                    let pVal = Math.min(emi - iVal, tempBal2);
                    if (pVal < 0) pVal = 0;
                    if (k <= consecutivePaidUpTo) {
                        accInterestUpToCutoff += iVal;
                    }
                    tempBal2 = Math.max(0, tempBal2 - pVal);
                }
                return accInterestUpToCutoff;
            })();

            const baselineRemainingInterest = totalStandardInterest - paidMonthsBaselineInterest;
            // FIX 5: Savings is the true difference ‚Äî how much less interest remains vs standard path.
            // We clamp to 0 on the low end (no negative savings shown) but the inputs are now correct.
            const interestSaved = Math.max(0, baselineRemainingInterest - totalInterestRemaining);

            // --- Render Table Rows ---
            for (let idx = 0; idx < schedule.length; idx++) {
                const s = schedule[idx];
                const i = s.month;

                let row = scheduleBody.rows[rowIdx];
                if (!row) {
                    row = scheduleBody.insertRow();
                    row.className = 'text-sm transition-colors';
                    for (let c = 0; c < 7; c++) row.insertCell();
                }

                // FIX 2: Highlight paid rows only if within the consecutive paid block
                const isConsecutivelyPaid = i <= consecutivePaidUpTo;
                row.className = `text-sm ${isConsecutivelyPaid ? 'bg-blue-50/30 dark:bg-blue-900/10' : 'hover:bg-slate-50 dark:hover:bg-slate-800/50'}`;

                // Month number ‚Äî append a warning icon for out-of-order paid months
                row.cells[0].className = 'px-6 py-3 font-medium text-xs text-slate-400';
                const isOutOfOrder = s.isPaid && !isConsecutivelyPaid;
                row.cells[0].textContent = i + (isOutOfOrder ? ' ‚ö†' : '');
                if (isOutOfOrder) row.cells[0].title = 'Out-of-order: prior month not marked paid. Metrics count from last consecutive paid month.';

                // Checkbox
                if (!row.cells[1].querySelector('input')) {
                    row.cells[1].className = 'px-6 py-3 text-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'paid-checkbox';
                    checkbox.onclick = () => togglePaidStatus(i);
                    row.cells[1].appendChild(checkbox);
                }
                row.cells[1].querySelector('input').checked = s.isPaid;

                row.cells[2].className = 'px-6 py-3 dark:text-slate-300';
                row.cells[2].textContent = `‚Çπ${s.opening.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                row.cells[3].className = 'px-6 py-3 text-red-500';
                row.cells[3].textContent = `‚Çπ${s.interest.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                row.cells[4].className = 'px-6 py-3 text-slate-600 dark:text-slate-400';
                row.cells[4].textContent = `‚Çπ${s.principalFromEMI.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                if (!row.cells[5].querySelector('input')) {
                    row.cells[5].className = 'px-6 py-3 bg-emerald-50/30 dark:bg-emerald-900/5';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `manualInput_${i}`;
                    input.placeholder = '0';
                    input.className = 'table-input font-bold text-emerald-600 dark:text-emerald-400';
                    input.oninput = (e) => updateManualPayment(i, e.target.value);
                    row.cells[5].appendChild(input);
                }
                const cellInput = row.cells[5].querySelector('input');
                if (cellInput.id !== activeInputId) {
                    cellInput.value = manualPrepayments[i.toString()] || '';
                }

                row.cells[6].className = 'px-6 py-3 text-right font-semibold dark:text-slate-200';
                row.cells[6].textContent = `‚Çπ${s.closing.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                rowIdx++;
            }

            // Remove stale rows
            while (scheduleBody.rows.length > rowIdx) {
                scheduleBody.deleteRow(rowIdx);
            }

            // --- Update Dashboard ---
            document.getElementById('remainingPrincipalDisplay').innerText = formatCurrency(actualRemainingPrincipal);
            document.getElementById('totalInterestPaidDisplay').innerText = formatCurrency(cumulativeInterestPaid);
            document.getElementById('totalRemainingInterestDisplay').innerText = formatCurrency(totalInterestRemaining);
            document.getElementById('totalPrincipalPaidDisplay').innerText = formatCurrency(totalPrincipalPaidSoFar);
            document.getElementById('monthsRemainingDisplay').innerText = unpaidMonthsCount;
            document.getElementById('totalAmountPaidDisplay').innerText = formatCurrency(totalPrincipalPaidSoFar + cumulativeInterestPaid);
            document.getElementById('savingsDisplay').innerText = formatCurrency(interestSaved);

            if (totalExtraPaid > 0) {
                document.getElementById('savingsBadge').classList.remove('hidden');
            } else {
                document.getElementById('savingsBadge').classList.add('hidden');
            }

            const totalRemainingValue = actualRemainingPrincipal + totalInterestRemaining;
            const pPercent = totalRemainingValue > 0 ? (actualRemainingPrincipal / totalRemainingValue) * 100 : 0;
            const iPercent = totalRemainingValue > 0 ? (totalInterestRemaining / totalRemainingValue) * 100 : 0;

            document.getElementById('pBar').style.width = pPercent + '%';
            document.getElementById('iBar').style.width = iPercent + '%';
            document.getElementById('pLabel').innerText = `Principal: ${pPercent.toFixed(1)}%`;
            document.getElementById('iLabel').innerText = `Interest: ${iPercent.toFixed(1)}%`;
        }
    </script>

    <!-- Export: zero CDN dependencies, pure JS -->
    <script>
        // ‚îÄ‚îÄ Collect ONLY the schedule table rows (no meta) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getTableData() {
            const headers = ['Month','Paid?','Opening Bal (INR)','Interest (INR)','Principal EMI (INR)','Extra Principal (INR)','Closing Bal (INR)'];
            const rows = [];
            for (const tr of document.getElementById('scheduleBody').rows) {
                const c = tr.cells;
                rows.push([
                    c[0].textContent.trim(),
                    c[1].querySelector('input') ? (c[1].querySelector('input').checked ? 'Yes' : 'No') : '',
                    c[2].textContent.trim().replace(/[^\d.]/g,''),
                    c[3].textContent.trim().replace(/[^\d.]/g,''),
                    c[4].textContent.trim().replace(/[^\d.]/g,''),
                    c[5].querySelector('input') ? (c[5].querySelector('input').value || '0') : '0',
                    c[6].textContent.trim().replace(/[^\d.]/g,''),
                ]);
            }
            return { headers, rows };
        }

        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 300);
        }

        // ‚îÄ‚îÄ CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportCSV() {
            const { headers, rows } = getTableData();
            const esc = v => '"' + String(v).replace(/"/g,'""') + '"';
            const lines = [
                headers.map(esc).join(','),
                ...rows.map(r => r.map(esc).join(','))
            ];
            triggerDownload(new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8;'}), 'emi_schedule.csv');
        }

        // ‚îÄ‚îÄ Excel (.xlsx) ‚Äî pure JS ZIP + OpenXML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportExcel() {
            const { headers, rows } = getTableData();

            function escXml(s) {
                return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&apos;');
            }

            // Build shared strings table for text values
            const sharedStrings = [];
            const ssMap = {};
            function getSS(val) {
                const s = String(val);
                if (ssMap[s] === undefined) { ssMap[s] = sharedStrings.length; sharedStrings.push(s); }
                return ssMap[s];
            }

            // Pre-populate shared strings
            [headers, ...rows].forEach(row => row.forEach(v => {
                const n = parseFloat(v);
                if (isNaN(n) || v === '') getSS(v);
            }));

            function buildSheetXml(data) {
                let xml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';
                xml += '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">';
                xml += '<sheetData>';
                data.forEach((row, ri) => {
                    xml += '<row r="'+(ri+1)+'">';
                    row.forEach((val, ci) => {
                        const colLetter = ci < 26 ? String.fromCharCode(65+ci) : 'A'+String.fromCharCode(65+ci-26);
                        const ref = colLetter+(ri+1);
                        const n = parseFloat(val);
                        if (!isNaN(n) && val !== '') {
                            xml += '<c r="'+ref+'" s="'+(ri===0?1:0)+'"><v>'+n+'</v></c>';
                        } else {
                            const idx = getSS(val);
                            xml += '<c r="'+ref+'" t="s" s="'+(ri===0?1:0)+'"><v>'+idx+'</v></c>';
                        }
                    });
                    xml += '</row>';
                });
                xml += '</sheetData></worksheet>';
                return xml;
            }

            function buildSSXml() {
                let xml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';
                xml += '<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="'+sharedStrings.length+'" uniqueCount="'+sharedStrings.length+'">';
                sharedStrings.forEach(s => { xml += '<si><t>'+escXml(s)+'</t></si>'; });
                xml += '</sst>';
                return xml;
            }

            const styleXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
                +'<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">'
                +'<fonts><font><sz val="10"/><name val="Calibri"/></font>'
                +'<font><sz val="10"/><name val="Calibri"/><b/><color rgb="FFFFFFFF"/></font></fonts>'
                +'<fills><fill><patternFill patternType="none"/></fill>'
                +'<fill><patternFill patternType="gray125"/></fill>'
                +'<fill><patternFill patternType="solid"><fgColor rgb="FF1E3A5F"/></patternFill></fill></fills>'
                +'<borders><border><left/><right/><top/><bottom/><diagonal/></border></borders>'
                +'<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>'
                +'<cellXfs>'
                +'<xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>'  // s=0 normal
                +'<xf numFmtId="0" fontId="1" fillId="2" borderId="0" xfId="0" applyFont="1" applyFill="1"/>'  // s=1 header
                +'</cellXfs></styleSheet>';

            const scheduleData = [headers, ...rows];
            const sheetXml = buildSheetXml(scheduleData);
            const ssXml = buildSSXml();

            // UTF-8 encode
            const enc = new TextEncoder();
            function toBytes(str) { return enc.encode(str); }

            function crc32(buf) {
                const t = new Uint32Array(256);
                for (let i=0;i<256;i++){let v=i;for(let j=0;j<8;j++)v=v&1?0xEDB88320^(v>>>1):v>>>1;t[i]=v;}
                let c=0xFFFFFFFF;
                for (let i=0;i<buf.length;i++) c=t[(c^buf[i])&0xFF]^(c>>>8);
                return (c^0xFFFFFFFF)>>>0;
            }
            function u16LE(n){return [n&0xFF,(n>>8)&0xFF];}
            function u32LE(n){return [n&0xFF,(n>>8)&0xFF,(n>>16)&0xFF,(n>>24)&0xFF];}

            const zipFiles = {
                '[Content_Types].xml': '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/><Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/></Types>',
                '_rels/.rels': '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>',
                'xl/workbook.xml': '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Schedule" sheetId="1" r:id="rId1"/></sheets></workbook>',
                'xl/_rels/workbook.xml.rels': '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/><Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/></Relationships>',
                'xl/worksheets/sheet1.xml': sheetXml,
                'xl/sharedStrings.xml': ssXml,
                'xl/styles.xml': styleXml,
            };

            const centralDir = [];
            const localParts = [];
            let localOffset = 0;

            for (const [name, content] of Object.entries(zipFiles)) {
                const nameBytes = toBytes(name);
                const dataBytes = toBytes(content);
                const crc = crc32(dataBytes);
                const sz = dataBytes.length;

                const local = new Uint8Array([
                    0x50,0x4B,0x03,0x04,
                    0x14,0x00, 0x00,0x00, 0x00,0x00,
                    0x00,0x00,0x00,0x00,
                    ...u32LE(crc),
                    ...u32LE(sz), ...u32LE(sz),
                    ...u16LE(nameBytes.length), 0x00,0x00,
                    ...nameBytes
                ]);
                const central = new Uint8Array([
                    0x50,0x4B,0x01,0x02,
                    0x14,0x00,0x14,0x00,
                    0x00,0x00, 0x00,0x00,
                    0x00,0x00,0x00,0x00,
                    ...u32LE(crc),
                    ...u32LE(sz), ...u32LE(sz),
                    ...u16LE(nameBytes.length),
                    0x00,0x00, 0x00,0x00,
                    0x00,0x00, 0x00,0x00,0x00,0x00,
                    ...u32LE(localOffset),
                    ...nameBytes
                ]);
                centralDir.push(central);
                localParts.push(local, dataBytes);
                localOffset += local.length + dataBytes.length;
            }

            const centralBytes = centralDir.reduce((acc, b) => { const n = new Uint8Array(acc.length+b.length); n.set(acc); n.set(b,acc.length); return n; }, new Uint8Array(0));
            const eocd = new Uint8Array([
                0x50,0x4B,0x05,0x06,
                0x00,0x00, 0x00,0x00,
                ...u16LE(Object.keys(zipFiles).length),
                ...u16LE(Object.keys(zipFiles).length),
                ...u32LE(centralBytes.length),
                ...u32LE(localOffset),
                0x00,0x00
            ]);

            // Concat all parts
            const totalLen = localParts.reduce((s,b)=>s+b.length,0) + centralBytes.length + eocd.length;
            const out = new Uint8Array(totalLen);
            let pos = 0;
            for (const b of localParts) { out.set(b, pos); pos += b.length; }
            out.set(centralBytes, pos); pos += centralBytes.length;
            out.set(eocd, pos);

            triggerDownload(new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), 'emi_schedule.xlsx');
        }

        // ‚îÄ‚îÄ PDF ‚Äî A4 Portrait, multi-page, clean grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportPDF() {
            const { headers, rows } = getTableData();

            // A4 Portrait: 595 x 842 pt
            const PW = 595, PH = 842;
            const ML = 24, MR = 24, MT = 54, MB = 30;
            const tableW = PW - ML - MR;   // 547 pt
            // col widths must sum to tableW=547
            const colW = [28, 22, 100, 90, 100, 100, 107];
            const HDR_H = 17, ROW_H = 13;
            // usable height per page for rows
            const TITLE_H = 26; // title bar on page 1
            const rows_p1 = Math.floor((PH - MT - TITLE_H - HDR_H - MB) / ROW_H);
            const rows_pN = Math.floor((PH - MT - HDR_H - MB) / ROW_H);
            const ROWS_PER_PAGE = (p) => p === 0 ? rows_p1 : rows_pN;

            function pdfStr(s) {
                return String(s)
                    .replace(/[^\x20-\x7E]/g, '')
                    .replace(/\\/g, '\\\\')
                    .replace(/\(/g, '\\(')
                    .replace(/\)/g, '\\)');
            }

            const enc = new TextEncoder();
            let pdfBytes = new Uint8Array(0);
            function appendStr(s) {
                const b = enc.encode(s);
                const n = new Uint8Array(pdfBytes.length + b.length);
                n.set(pdfBytes); n.set(b, pdfBytes.length);
                pdfBytes = n;
            }

            appendStr('%PDF-1.4\n');

            const objOffsets = [];
            let nextId = 1;
            function startObj() { objOffsets.push(pdfBytes.length); appendStr(nextId + ' 0 obj\n'); return nextId++; }
            function endObj()   { appendStr('endobj\n'); }

            // ‚îÄ‚îÄ Slice rows into pages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const pages = [];
            let remaining = rows.slice();
            let pg = 0;
            while (remaining.length > 0) {
                const take = ROWS_PER_PAGE(pg);
                pages.push(remaining.splice(0, take));
                pg++;
            }
            if (pages.length === 0) pages.push([]); // at least one page

            const pageCount = pages.length;

            // ‚îÄ‚îÄ Build content stream for each page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const pageStreams = [];

            for (let p = 0; p < pageCount; p++) {
                const pageRows = pages[p];
                let s = '';

                // Title bar ‚Äî first page only
                let cursorY = PH - MT;
                if (p === 0) {
                    s += '0.118 0.227 0.373 rg\n';
                    s += ML + ' ' + cursorY + ' ' + tableW + ' ' + TITLE_H + ' re f\n';
                    s += '1 1 1 rg\n';
                    s += 'BT /F2 11 Tf ' + (ML + 5) + ' ' + (cursorY + 7) + ' Td (EMI Amortization Schedule) Tj ET\n';
                    cursorY -= TITLE_H;
                }

                // Column header bar
                const headerTop = cursorY;
                s += '0.118 0.227 0.373 rg\n';
                s += ML + ' ' + (headerTop - HDR_H) + ' ' + tableW + ' ' + HDR_H + ' re f\n';
                s += '1 1 1 rg\n';
                let hx = ML;
                headers.forEach((h, i) => {
                    s += 'BT /F2 6 Tf ' + (hx + 2) + ' ' + (headerTop - HDR_H + 5) + ' Td (' + pdfStr(h) + ') Tj ET\n';
                    hx += colW[i];
                });
                cursorY = headerTop - HDR_H;

                // Data rows
                const rowsTop = cursorY; // top of first data row area = bottom of header
                pageRows.forEach((row, ri) => {
                    const rowY = cursorY - ROW_H;

                    // Row fill
                    if (row[1] === 'Yes') {
                        s += '0.859 0.918 0.996 rg\n';
                    } else {
                        s += (ri % 2 === 0 ? '1 1 1 rg\n' : '0.957 0.957 0.957 rg\n');
                    }
                    s += ML + ' ' + rowY + ' ' + tableW + ' ' + ROW_H + ' re f\n';

                    // Cell text
                    let cx = ML;
                    row.forEach((val, ci) => {
                        if      (ci === 3) s += '0.72 0.15 0.15 rg\n';
                        else if (ci === 5) s += '0.08 0.45 0.30 rg\n';
                        else               s += '0.12 0.12 0.12 rg\n';
                        s += 'BT /F1 6 Tf ' + (cx + 2) + ' ' + (rowY + 4) + ' Td (' + pdfStr(val) + ') Tj ET\n';
                        cx += colW[ci];
                    });

                    cursorY = rowY;
                });

                const tableBottom = cursorY; // y coordinate of bottom edge of last row

                // ‚îÄ‚îÄ Draw grid lines ONCE, cleanly ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Outer border
                s += '0.55 0.55 0.55 RG 0.4 w\n';
                s += ML + ' ' + tableBottom + ' ' + tableW + ' ' + (headerTop - tableBottom) + ' re S\n';

                // Horizontal line under header
                s += '0.55 0.55 0.55 RG 0.4 w\n';
                s += ML + ' ' + rowsTop + ' m ' + (ML + tableW) + ' ' + rowsTop + ' l S\n';

                // Horizontal lines between rows (only between rows, not at bottom ‚Äî outer border covers it)
                s += '0.80 0.80 0.80 RG 0.25 w\n';
                let lineY = rowsTop;
                for (let ri = 0; ri < pageRows.length - 1; ri++) {
                    lineY -= ROW_H;
                    s += ML + ' ' + lineY + ' m ' + (ML + tableW) + ' ' + lineY + ' l S\n';
                }

                // Vertical column dividers (inside only, not outer edges ‚Äî outer border covers those)
                s += '0.80 0.80 0.80 RG 0.25 w\n';
                let vx = ML;
                for (let ci = 0; ci < colW.length - 1; ci++) {
                    vx += colW[ci];
                    s += vx + ' ' + tableBottom + ' m ' + vx + ' ' + headerTop + ' l S\n';
                }

                // Footer
                s += '0.55 0.55 0.55 rg\n';
                s += 'BT /F1 6.5 Tf ' + (PW / 2 - 50) + ' ' + (MB - 10) + ' Td (Page ' + (p + 1) + ' of ' + pageCount + '   |   Generated: ' + new Date().toLocaleDateString('en-IN') + ') Tj ET\n';

                pageStreams.push(s);
            }

            // ‚îÄ‚îÄ Write PDF objects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // IDs: 1=catalog, 2=pages, 3=fontRegular, 4=fontBold,
            //      then pairs (pageObj, streamObj) for each page: 5,6 / 7,8 / ...
            const fontRegId = 3, fontBoldId = 4;
            const pageObjIds   = Array.from({length: pageCount}, (_, i) => 5 + i * 2);
            const streamObjIds = Array.from({length: pageCount}, (_, i) => 6 + i * 2);

            // 1: Catalog
            startObj(); appendStr('<</Type /Catalog /Pages 2 0 R>>\n'); endObj();
            // 2: Pages
            startObj();
            appendStr('<</Type /Pages /Kids [' + pageObjIds.map(id => id + ' 0 R').join(' ') + '] /Count ' + pageCount + '>>\n');
            endObj();
            // 3: Regular font
            startObj(); appendStr('<</Type /Font /Subtype /Type1 /BaseFont /Helvetica /Encoding /WinAnsiEncoding>>\n'); endObj();
            // 4: Bold font
            startObj(); appendStr('<</Type /Font /Subtype /Type1 /BaseFont /Helvetica-Bold /Encoding /WinAnsiEncoding>>\n'); endObj();

            // Page + stream pairs
            for (let p = 0; p < pageCount; p++) {
                const sc = pageStreams[p];
                const sb = enc.encode(sc).length;
                // Page obj
                startObj();
                appendStr('<</Type /Page /Parent 2 0 R /MediaBox [0 0 ' + PW + ' ' + PH + ']\n');
                appendStr('/Contents ' + streamObjIds[p] + ' 0 R\n');
                appendStr('/Resources <</Font <</F1 ' + fontRegId + ' 0 R /F2 ' + fontBoldId + ' 0 R>>>>>>\n');
                endObj();
                // Stream obj
                startObj();
                appendStr('<</Length ' + sb + '>>\nstream\n');
                appendStr(sc);
                appendStr('\nendstream\n');
                endObj();
            }

            // xref + trailer
            const xrefOffset = pdfBytes.length;
            const total = objOffsets.length + 1;
            appendStr('xref\n0 ' + total + '\n');
            appendStr('0000000000 65535 f \n');
            objOffsets.forEach(o => appendStr(o.toString().padStart(10, '0') + ' 00000 n \n'));
            appendStr('trailer\n<</Size ' + total + ' /Root 1 0 R>>\n');
            appendStr('startxref\n' + xrefOffset + '\n%%EOF\n');

            triggerDownload(new Blob([pdfBytes], {type: 'application/pdf'}), 'emi_schedule.pdf');
        }
    </script>

</body>
</html>
